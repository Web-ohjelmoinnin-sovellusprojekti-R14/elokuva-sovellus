name: CI/CD via DO Container Registry

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com/kinodroch
  BACKEND_IMAGE: elokuva-backend
  FRONTEND_IMAGE: elokuva-frontend

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Optional â€“ helps debug paths first time
      - name: List repo files
        run: ls -R

      # Build backend (Express) image from backend/Dockerfile
      - name: Build backend image
        run: |
          docker build \
            -t $REGISTRY/$BACKEND_IMAGE:$(echo $GITHUB_SHA | head -c7) \
            -f backend/Dockerfile \
            backend

      # Build frontend (React) image from frontend/Dockerfile
      - name: Build frontend image
        run: |
          docker build \
            -t $REGISTRY/$FRONTEND_IMAGE:$(echo $GITHUB_SHA | head -c7) \
            -f frontend/Dockerfile \
            frontend

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600

      # Push backend image
      - name: Push backend image
        run: docker push $REGISTRY/$BACKEND_IMAGE:$(echo $GITHUB_SHA | head -c7)

      # Push frontend image
      - name: Push frontend image
        run: docker push $REGISTRY/$FRONTEND_IMAGE:$(echo $GITHUB_SHA | head -c7)

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # login to DO registry
            docker login -u ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} -p ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} registry.digitalocean.com

            # Stop old containers if running
            docker stop $BACKEND_IMAGE || true
            docker rm $BACKEND_IMAGE || true
            docker stop $FRONTEND_IMAGE || true
            docker rm $FRONTEND_IMAGE || true

            # Start Postgres (once) if not already running
            docker volume create db-data || true
            docker stop postgres || true
            docker rm postgres || true
            docker run -d \
              --restart always \
              --name postgres \
              -e POSTGRES_USER=postgres \
              -e POSTGRES_PASSWORD=10032005 \
              -e POSTGRES_DB=kinodroch_db \
              -v db-data:/var/lib/postgresql/data \
              -p 5432:5432 \
              postgres:16

            # Run backend container (adjust envs/ports if needed)
            docker run -d \
              --restart always \
              --name $BACKEND_IMAGE \
              --link postgres:postgres \
              -e DB_HOST=postgres \
              -e DB_PORT=5432 \
              -e DB_USER=postgres \
              -e DB_PASSWORD=10032005 \
              -e DB_NAME=kinodroch_db \
              -p 5000:5000 \
              $REGISTRY/$BACKEND_IMAGE:$(echo $GITHUB_SHA | head -c7)

            # Run frontend container (adjust port if you proxy differently)
            docker run -d \
              --restart always \
              --name $FRONTEND_IMAGE \
              -e REACT_APP_API_URL=http://157.230.20.251:5000 \
              -p 3000:3000 \
              $REGISTRY/$FRONTEND_IMAGE:$(echo $GITHUB_SHA | head -c7)
